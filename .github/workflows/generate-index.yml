name: Generate Tailwind Index

on:
  push:
    branches:
      - main          # 如果你的默认分支叫 master，就改成 master
    paths:
      - 'posts/**'    # 只有 posts 下面变动才触发

jobs:
  build-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # 允许这个 workflow 往仓库里提交 index.html

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build index.html
        run: |
          # 没有文章就直接退出
          if ! ls posts/*/meta.json >/dev/null 2>&1; then
            echo "No posts/meta.json found, skipping."
            exit 0
          fi

          # 1. 写入 HTML 头部
          cat > index.html << 'HEADER'
          <!DOCTYPE html>
          <html lang="zh-CN" class="scroll-smooth">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ZZL · Notes & Lab</title>
              <script src="https://cdn.tailwindcss.com"></script>
              <script src="https://unpkg.com/@phosphor-icons/web"></script>
              <style>
                  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Serif+SC:wght@400;700&display=swap');
                  body {
                      font-family: 'Inter', 'Noto Serif SC', sans-serif;
                      background-color: #f8fafc;
                      color: #1e293b;
                  }
                  h1, h2, h3, h4 {
                      font-family: 'Inter', sans-serif;
                      letter-spacing: -0.025em;
                  }
                  ::-webkit-scrollbar { width: 8px; }
                  ::-webkit-scrollbar-track { background: #f1f1f1; }
                  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
                  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
              </style>
          </head>
          <body class="antialiased">
              <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
                  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                      <div class="flex items-center space-x-2 text-slate-800 font-bold text-xl">
                          <i class="ph ph-cube-transparent text-blue-600 text-2xl"></i>
                          <span>ZZL · Lab</span>
                      </div>
                      <div class="hidden md:flex space-x-8 text-sm font-medium text-slate-600">
                          <a href="/index.html" class="hover:text-blue-600 transition">首页</a>
                          <a href="#posts" class="hover:text-blue-600 transition">文章</a>
                          <a href="/about.html" class="hover:text-blue-600 transition">关于</a>
                          <a href="https://github.com/ZZL-2005/ZZL.github.io" class="hover:text-blue-600 transition">Github</a>
                      </div>
                  </div>
              </nav>

              <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                  <section class="mb-10">
                      <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-3">
                          个人学习 · 作业 · 随想
                      </h1>
                      <p class="text-slate-600 max-w-2xl">
                          这里记录课程作业、AI 学习笔记，还有一些乱七八糟但挺有意思的想法。
                      </p>
                  </section>

                  <section id="posts" class="space-y-6">
                      <div class="flex items-center justify-between mb-2">
                          <h2 class="text-xl font-semibold text-slate-900">最近更新</h2>
                      </div>
          HEADER

          # 2. 用 jq 读取所有 meta.json，并按 date 倒序排序
          posts_json=$(jq -s 'sort_by(.date) | reverse' posts/*/meta.json)

          echo "$posts_json" | jq -c '.[]' | while read -r post; do
            title=$(echo "$post"    | jq -r '.title')
            subtitle=$(echo "$post" | jq -r '.subtitle')
            date=$(echo "$post"     | jq -r '.date')
            reading=$(echo "$post"  | jq -r '.reading')
            summary=$(echo "$post"  | jq -r '.summary')
            path=$(echo "$post"     | jq -r '.path')
            # 把 tags 数组拼成用 · 分隔的字符串
            tags=$(echo "$post"     | jq -r '.tags | join(" · ")')

            cat >> index.html << CARD
                      <article class="bg-white border border-slate-200 rounded-xl shadow-sm p-6 flex flex-col md:flex-row md:items-center md:justify-between hover:border-blue-300 hover:shadow-md transition">
                          <div class="space-y-2">
                              <div class="flex flex-wrap items-center gap-2 text-xs">
                                  <span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 font-semibold">${tags}</span>
                              </div>
                              <h3 class="text-lg font-semibold text-slate-900">
                                  <a href="${path}" class="hover:text-blue-600 transition">
                                      ${title}
                                  </a>
                              </h3>
                              <p class="text-sm text-slate-600 max-w-2xl">
                                  ${summary}
                              </p>
                              <p class="text-xs text-slate-400">
                                  ${date} · ${reading}
                              </p>
                          </div>
                          <div class="mt-4 md:mt-0 flex items-center space-x-3 text-sm">
                              <a href="${path}" class="inline-flex items-center text-blue-600 hover:text-blue-700">
                                  阅读全文 <i class="ph ph-arrow-right ml-1"></i>
                              </a>
                          </div>
                      </article>
          CARD
          done

          # 3. 收尾 HTML
          cat >> index.html << 'FOOTER'
                  </section>
              </main>

              <footer class="bg-white border-t border-slate-200 py-8 mt-12">
                  <div class="max-w-7xl mx-auto px-4 text-center">
                      <p class="text-slate-500 text-sm">© 2025 ZZL. Built with HTML & Tailwind on GitHub Pages.</p>
                  </div>
              </footer>
          </body>
          </html>
          FOOTER

      - name: Commit and push index.html if changed
        run: |
          if git diff --quiet index.html; then
            echo "index.html 没有变化，跳过提交。"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add index.html
          git commit -m "chore: auto-generate index.html"
          git push
